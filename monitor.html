<!DOCTYPE html>
<html>
<head>
    <title>ZHTP Network Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .panel { background: white; border: 1px solid #ddd; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status { font-weight: bold; padding: 5px 10px; border-radius: 4px; }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .metric { display: flex; justify-content: space-between; margin: 10px 0; }
        .value { font-weight: bold; color: #007bff; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
        .refresh-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .refresh-btn:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>ZHTP Multi-Node Network Monitor</h1>
    <button class="refresh-btn" onclick="refreshAll()">Refresh All</button>
    
    <div class="dashboard">
        <div class="panel">
            <h3>Network Status</h3>
            <div id="network-status">Loading...</div>
            <div class="metric">
                <span>Uptime:</span>
                <span class="value" id="uptime">-</span>
            </div>
            <div class="metric">
                <span>Version:</span>
                <span class="value" id="version">-</span>
            </div>
        </div>
        
        <div class="panel">
            <h3>Connected Peers</h3>
            <div id="peer-count" class="metric">
                <span>Total Peers:</span>
                <span class="value">0</span>
            </div>
            <table id="peer-table">
                <thead>
                    <tr><th>Node ID</th><th>Type</th><th>Status</th></tr>
                </thead>
                <tbody id="peer-list">
                    <tr><td colspan="3">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="panel">
            <h3>Blockchain Status</h3>
            <div class="metric">
                <span>Block Height:</span>
                <span class="value" id="block-height">-</span>
            </div>
            <div class="metric">
                <span>Transactions:</span>
                <span class="value" id="tx-count">-</span>
            </div>
            <div class="metric">
                <span>Consensus:</span>
                <span class="value" id="consensus-status">-</span>
            </div>
        </div>
        
        <div class="panel">
            <h3>Security Events</h3>
            <div id="security-summary" class="metric">
                <span>Threat Level:</span>
                <span class="value status online">Low</span>
            </div>
            <div id="security-events">
                <div>No recent security events</div>
            </div>
        </div>
        
        <div class="panel">
            <h3>Token Economics</h3>
            <div class="metric">
                <span>Total Supply:</span>
                <span class="value" id="total-supply">-</span>
            </div>
            <div class="metric">
                <span>Circulating:</span>
                <span class="value" id="circulating">-</span>
            </div>
            <div class="metric">
                <span>Rewards Distributed:</span>
                <span class="value" id="rewards">-</span>
            </div>
        </div>
        
        <div class="panel">
            <h3>DHT Storage</h3>
            <div class="metric">
                <span>Stored Keys:</span>
                <span class="value" id="dht-keys">-</span>
            </div>
            <div class="metric">
                <span>Replication Factor:</span>
                <span class="value" id="replication">-</span>
            </div>
            <div class="metric">
                <span>Storage Usage:</span>
                <span class="value" id="storage-usage">-</span>
            </div>
        </div>
    </div>

    <script>
        const BOOTSTRAP_IP = '127.0.0.1';
        let refreshInterval;
        
        async function fetchWithFallback(url, fallback = {}) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                return fallback;
            }
        }
        
        async function updateNetworkStatus() {
            const status = await fetchWithFallback(http://:7000/api/status, {
                status: 'offline',
                version: 'unknown',
                uptime: 0
            });
            
            const statusEl = document.getElementById('network-status');
            if (status.status === 'offline') {
                statusEl.innerHTML = '<span class="status offline">Offline</span>';
            } else {
                statusEl.innerHTML = '<span class="status online">Online</span>';
            }
            
            document.getElementById('uptime').textContent = status.uptime || '0s';
            document.getElementById('version').textContent = status.version || 'unknown';
        }
        
        async function updatePeers() {
            const data = await fetchWithFallback(http://:7000/api/peers, {
                peers: []
            });
            
            const peerList = document.getElementById('peer-list');
            const peerCount = document.getElementById('peer-count').querySelector('.value');
            
            peerCount.textContent = data.peers.length;
            
            if (data.peers.length === 0) {
                peerList.innerHTML = '<tr><td colspan="3">No peers connected</td></tr>';
            } else {
                peerList.innerHTML = data.peers.map(peer => 
                    <tr>
                        <td>...</td>
                        <td></td>
                        <td><span class="status online">Online</span></td>
                    </tr>
                ).join('');
            }
        }
        
        async function updateBlockchain() {
            const data = await fetchWithFallback(http://:7000/api/blockchain/status, {
                height: 0,
                transactions: 0,
                consensus: 'unknown'
            });
            
            document.getElementById('block-height').textContent = data.height || '0';
            document.getElementById('tx-count').textContent = data.transactions || '0';
            document.getElementById('consensus-status').textContent = data.consensus || 'unknown';
        }
        
        async function updateTokens() {
            const data = await fetchWithFallback(http://:7000/api/tokens/stats, {
                total_supply: 0,
                circulating: 0,
                rewards: 0
            });
            
            document.getElementById('total-supply').textContent = data.total_supply || '0';
            document.getElementById('circulating').textContent = data.circulating || '0';
            document.getElementById('rewards').textContent = data.rewards || '0';
        }
        
        async function updateDHT() {
            const data = await fetchWithFallback(http://:7000/api/dht/stats, {
                keys: 0,
                replication: 0,
                usage: '0 MB'
            });
            
            document.getElementById('dht-keys').textContent = data.keys || '0';
            document.getElementById('replication').textContent = data.replication || '0';
            document.getElementById('storage-usage').textContent = data.usage || '0 MB';
        }
        
        function refreshAll() {
            updateNetworkStatus();
            updatePeers();
            updateBlockchain();
            updateTokens();
            updateDHT();
        }
        
        // Auto-refresh every 10 seconds
        function startAutoRefresh() {
            refreshAll();
            refreshInterval = setInterval(refreshAll, 10000);
        }
        
        // Initialize
        startAutoRefresh();
        
        // Stop auto-refresh when page is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                clearInterval(refreshInterval);
            } else {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>
